<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - Airport Management System</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>✈️ Airport Management System</h1>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html">Home</a></li>
                <li><a href="flights.html">Flights</a></li>
                <li><a href="airports.html">Airports</a></li>
                <li><a href="bookings.html" class="active">My Bookings</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="page-content">
        <div class="container">
            <h1>My Bookings</h1>

            <!-- Bookings List -->
            <div id="bookingsList" class="bookings-container">
                <p class="loading">Loading your bookings...</p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Airport Management System. All rights reserved.</p>
        </div>
    </footer>

    <script src="assets/js/main.js"></script>
    <script>
        requireAuth();
        updateNavigation();
        loadBookings();

        async function loadBookings() {
            try {
                const response = await fetch('/AirportManagementSystem/booking/my-bookings');
                const result = await response.json();

                const container = document.getElementById('bookingsList');

                if (!result.success) {
                    container.innerHTML = `<p class="error">${result.error}</p>`;
                    return;
                }

                if (result.data.length === 0) {
                    container.innerHTML = `
                        <div class="no-bookings">
                            <p>You don't have any bookings yet.</p>
                            <a href="flights.html" class="btn btn-primary">Search Flights</a>
                        </div>
                    `;
                    return;
                }

                const html = result.data.map(booking => {
                    const departureDate = new Date(booking.departureTime);
                    const bookingDate = new Date(booking.bookingDate);
                    
                    return `
                        <div class="booking-card ${booking.status.toLowerCase()}">
                            <div class="booking-header">
                                <h3>${booking.flightNumber}</h3>
                                <span class="booking-status status-${booking.status.toLowerCase()}">
                                    ${booking.status}
                                </span>
                            </div>
                            <div class="booking-details">
                                <div class="booking-route">
                                    <div class="route-point">
                                        <strong>${booking.sourceAirportCode}</strong>
                                    </div>
                                    <div class="route-arrow">✈️</div>
                                    <div class="route-point">
                                        <strong>${booking.destinationAirportCode}</strong>
                                    </div>
                                </div>
                                <div class="booking-info">
                                    <p><strong>Departure:</strong> ${formatDateTime(departureDate)}</p>
                                    <p><strong>Seats:</strong> ${booking.seatsBooked}</p>
                                    <p><strong>Total Price:</strong> $${booking.totalPrice.toFixed(2)}</p>
                                    <p><strong>Booked on:</strong> ${formatDateTime(bookingDate)}</p>
                                </div>
                            </div>
                            <div class="booking-actions">
                                ${booking.status === 'CONFIRMED' ? `
                                    <button class="btn btn-danger" onclick="cancelBooking(${booking.id})">
                                        Cancel Booking
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsList').innerHTML = 
                    '<p class="error">Failed to load bookings. Please try again.</p>';
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) {
                return;
            }

            try {
                const response = await fetch(`/AirportManagementSystem/booking/cancel/${bookingId}`, {
                    method: 'PUT'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Booking cancelled successfully', 'success');
                    loadBookings(); // Reload bookings
                } else {
                    showNotification(result.error || 'Failed to cancel booking', 'error');
                }
            } catch (error) {
                console.error('Error cancelling booking:', error);
                showNotification('Failed to cancel booking. Please try again.', 'error');
            }
        }

        function formatDateTime(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
